<!DOCTYPE html>
<html lang="id">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Bendahara</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            border-radius: 1rem;
        }
        .table thead th {
            background-color: #0d6efd;
            color: white;
        }
    </style>
</head>
<body class="p-4">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="text-primary">Dashboard Bendahara</h1>
            <div class="d-flex gap-2">
                <button id="cetakPdfBtn" class="btn btn-secondary">
                    <i class="fas fa-print me-2"></i> Cetak Laporan
                </button>
                <button id="tambahTransaksiBtn" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i> Tambah Data
                </button>
                <form action="dashboardBendahara.html" method="get">
                    <button type="submit" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i> Kembali
                    </button>
                </form>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-auto">
                <label for="filterBulan" class="form-label">Filter:</label>
                <select id="filterBulan" class="form-select">
                    <option value="Semua Bulan">Semua Bulan</option>
                    <option value="1">Januari</option>
                    <option value="2">Februari</option>
                    <option value="3">Maret</option>
                    <option value="4">April</option>
                    <option value="5">Mei</option>
                    <option value="6">Juni</option>
                    <option value="7">Juli</option>
                    <option value="8">Agustus</option>
                    <option value="9">September</option>
                    <option value="10">Oktober</option>
                    <option value="11">November</option>
                    <option value="12">Desember</option>
                </select>
            </div>
            <div class="col-md-auto">
                <label for="filterTahun" class="form-label">&nbsp;</label>
                <select id="filterTahun" class="form-select"></select>
            </div>
        </div>

        <div class="card shadow-sm p-4 mb-4">
            <h2 class="card-title text-secondary">Ringkasan Bulanan Tahun <span id="tahunRingkasan"></span></h2>
            <div class="table-responsive">
                <table class="table table-bordered table-striped mt-3">
                    <thead>
                        <tr>
                            <th class="text-center">Bulan</th>
                            <th class="text-end">Total Pemasukan</th>
                            <th class="text-end">Total Pengeluaran</th>
                            <th class="text-end">Saldo Akhir</th>
                        </tr>
                    </thead>
                    <tbody id="ringkasanBulananTbody"></tbody>
                </table>
            </div>
        </div>

        <div class="card shadow-sm p-4 mb-4">
            <h2 class="card-title text-secondary">Daftar Semua Transaksi Tahun <span id="tahunTransaksi"></span></h2>
            <div class="table-responsive">
                <table class="table table-bordered table-striped mt-3">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Keterangan</th>
                            <th>Jenis</th>
                            <th class="text-end">Jumlah</th>
                            <th class="text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="transaksiTbody"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="fw-bold text-end">Total Pemasukan:</td>
                            <td id="totalPemasukan" class="fw-bold text-end text-success"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="3" class="fw-bold text-end">Total Pengeluaran:</td>
                            <td id="totalPengeluaran" class="fw-bold text-end text-danger"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="3" class="fw-bold text-end">Saldo Akhir:</td>
                            <td id="saldoAkhir" class="fw-bold text-end"></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for Tambah/Edit -->
    <div class="modal fade" id="modalTransaksi" tabindex="-1" aria-labelledby="modalTransaksiLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Tambah Transaksi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="message-box-modal" class="alert d-none" role="alert"></div>
                    <form>
                        <input type="hidden" id="modalId">
                        <div class="mb-3">
                            <label for="modalTanggal" class="form-label">Tanggal</label>
                            <input type="date" class="form-control" id="modalTanggal">
                        </div>
                        <div class="mb-3">
                            <label for="modalKeterangan" class="form-label">Keterangan</label>
                            <input type="text" class="form-control" id="modalKeterangan" list="keteranganList" placeholder="Pilih atau ketik baru...">
                            <datalist id="keteranganList"></datalist>
                        </div>
                        <div class="mb-3">
                            <label for="modalJenis" class="form-label">Jenis</label>
                            <select class="form-select" id="modalJenis">
                                <option value="masuk">Masuk</option>
                                <option value="keluar">Keluar</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="modalJumlah" class="form-label">Jumlah</label>
                            <input type="text" class="form-control text-end" id="modalJumlah">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="saveModalBtn">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Delete Confirmation -->
    <div class="modal fade" id="modalDelete" tabindex="-1" aria-labelledby="modalDeleteLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalDeleteLabel">Konfirmasi Hapus</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Apakah Anda yakin ingin menghapus data ini?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelDeleteBtn">Batal</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Hapus</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tambahTransaksiBtn = document.getElementById('tambahTransaksiBtn');
            const cetakPdfBtn = document.getElementById('cetakPdfBtn');
            const filterBulan = document.getElementById('filterBulan');
            const filterTahun = document.getElementById('filterTahun');
            const ringkasanBulananTbody = document.getElementById('ringkasanBulananTbody');
            const transaksiTbody = document.getElementById('transaksiTbody');
            const totalPemasukan = document.getElementById('totalPemasukan');
            const totalPengeluaran = document.getElementById('totalPengeluaran');
            const saldoAkhir = document.getElementById('saldoAkhir');
            
            const modalTransaksi = new bootstrap.Modal(document.getElementById('modalTransaksi'));
            const modalDelete = new bootstrap.Modal(document.getElementById('modalDelete'));
            const modalTitle = document.getElementById('modalTitle');
            const modalTanggal = document.getElementById('modalTanggal');
            const modalKeterangan = document.getElementById('modalKeterangan');
            const keteranganList = document.getElementById('keteranganList');
            const modalJenis = document.getElementById('modalJenis');
            const modalJumlah = document.getElementById('modalJumlah');
            const modalId = document.getElementById('modalId');
            const saveModalBtn = document.getElementById('saveModalBtn');
            const messageBoxModal = document.getElementById('message-box-modal');

            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

            let deleteId = null;
            let data;

            function showMessage(element, text, style) {
                element.textContent = text;
                element.className = `alert ${style} d-block`;
                setTimeout(() => {
                    element.classList.add('d-none');
                }, 3000);
            }

            function formatNumber(num) {
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            }

            function unformatNumber(str) {
                return str ? parseInt(str.toString().replace(/\./g, '')) : 0;
            }

            function loadData() {
                const selectedYear = filterTahun.value;
                const selectedMonth = filterBulan.value;
                
                document.getElementById('tahunRingkasan').textContent = selectedYear;
                document.getElementById('tahunTransaksi').textContent = selectedYear;
                
                if (typeof google !== 'undefined' && typeof google.script.run !== 'undefined') {
                    google.script.run
                        .withSuccessHandler(response => {
                            data = JSON.parse(response);
                            
                            ringkasanBulananTbody.innerHTML = '';
                            if (data.laporanBulanan.length > 0) {
                                data.laporanBulanan.forEach(item => {
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td class="text-center">${item.bulan}</td>
                                        <td class="text-end text-success">${formatNumber(item.pemasukan)}</td>
                                        <td class="text-end text-danger">${formatNumber(item.pengeluaran)}</td>
                                        <td class="text-end">${formatNumber(item.saldoAkhir)}</td>
                                    `;
                                    ringkasanBulananTbody.appendChild(row);
                                });
                            } else {
                                ringkasanBulananTbody.innerHTML = `<tr><td colspan="4" class="text-center">Tidak ada data untuk periode yang dipilih.</td></tr>`;
                            }

                            transaksiTbody.innerHTML = '';
                            if (data.dataTransaksi.length > 0) {
                                data.dataTransaksi.forEach(transaksi => {
                                    const row = document.createElement('tr');
                                    const badgeClass = transaksi.jenis === 'masuk' ? 'bg-success' : 'bg-danger';
                                    row.innerHTML = `
                                        <td>${transaksi.tanggal}</td>
                                        <td>${transaksi.keterangan}</td>
                                        <td><span class="badge ${badgeClass}">${transaksi.jenis}</span></td>
                                        <td class="text-end">${formatNumber(transaksi.jumlah)}</td>
                                        <td class="text-center">
                                            <button onclick="editTransaksi(${transaksi.id})" class="btn btn-sm btn-info me-2"><i class="fas fa-edit"></i></button>
                                            <button onclick="confirmDelete(${transaksi.id})" class="btn btn-sm btn-danger"><i class="fas fa-trash-alt"></i></button>
                                        </td>
                                    `;
                                    transaksiTbody.appendChild(row);
                                });
                            } else {
                                transaksiTbody.innerHTML = `<tr><td colspan="5" class="text-center">Tidak ada data untuk periode yang dipilih.</td></tr>`;
                            }

                            totalPemasukan.textContent = formatNumber(data.totalPemasukan);
                            totalPengeluaran.textContent = formatNumber(data.totalPengeluaran);
                            saldoAkhir.textContent = formatNumber(data.saldoAkhir);
                            if (data.saldoAkhir < 0) {
                                saldoAkhir.classList.add('text-danger');
                                saldoAkhir.classList.remove('text-success');
                            } else {
                                saldoAkhir.classList.add('text-success');
                                saldoAkhir.classList.remove('text-danger');
                            }
                        })
                        .withFailureHandler(error => {
                            console.error("Error fetching data:", error);
                        })
                        .getLaporan(selectedYear, selectedMonth);
                } else {
                    console.warn("google.script.run is not defined.");
                }
            }

            function loadKeterangan() {
                if (typeof google !== 'undefined' && typeof google.script.run !== 'undefined') {
                    google.script.run
                        .withSuccessHandler(response => {
                            const keteranganListOptions = JSON.parse(response);
                            keteranganList.innerHTML = '';
                            keteranganListOptions.forEach(k => {
                                const option = document.createElement('option');
                                option.value = k;
                                keteranganList.appendChild(option);
                            });
                        })
                        .withFailureHandler(error => {
                            console.error("Error fetching keterangan:", error);
                        })
                        .getKeterangan();
                }
            }

            window.editTransaksi = (id) => {
                const selectedTransaksi = data.dataTransaksi.find(t => t.id == id);
                if (selectedTransaksi) {
                    modalTitle.textContent = 'Edit Transaksi';
                    modalId.value = selectedTransaksi.id;
                    
                    const [day, month, year] = selectedTransaksi.tanggal.split('-');
                    modalTanggal.value = `${year}-${month}-${day}`;

                    modalKeterangan.value = selectedTransaksi.keterangan;
                    modalJenis.value = selectedTransaksi.jenis;
                    modalJumlah.value = formatNumber(selectedTransaksi.jumlah);
                    
                    loadKeterangan();
                    modalTransaksi.show();
                }
            };

            window.confirmDelete = (id) => {
                deleteId = id;
                modalDelete.show();
            };

            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= 2020; i--) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                filterTahun.appendChild(option);
            }
            filterTahun.value = currentYear;

            // Event Listeners
            tambahTransaksiBtn.addEventListener('click', () => {
                modalTitle.textContent = 'Tambah Transaksi';
                modalId.value = '';
                modalTanggal.value = new Date().toISOString().slice(0, 10);
                modalJenis.value = 'masuk';
                modalJumlah.value = '';
                modalKeterangan.value = '';
                loadKeterangan();
                modalTransaksi.show();
            });

            saveModalBtn.addEventListener('click', () => {
                const id = modalId.value;
                const tanggal = modalTanggal.value;
                const jenis = modalJenis.value;
                const keterangan = modalKeterangan.value.trim();
                const jumlah = unformatNumber(modalJumlah.value);

                if (!tanggal || !jenis || !jumlah || !keterangan) {
                    showMessage(messageBoxModal, 'Semua kolom harus diisi.', 'alert-danger');
                    return;
                }
                
                const transaksi = { id, tanggal, keterangan, jenis, jumlah };

                if (typeof google !== 'undefined' && typeof google.script.run !== 'undefined') {
                    if (id) {
                        google.script.run
                            .withSuccessHandler(() => {
                                modalTransaksi.hide();
                                loadData();
                            })
                            .withFailureHandler(error => {
                                showMessage(messageBoxModal, `Gagal mengedit data: ${error.message}`, 'alert-danger');
                            })
                            .editTransaksi(transaksi);
                    } else {
                        google.script.run
                            .withSuccessHandler(() => {
                                modalTransaksi.hide();
                                loadData();
                            })
                            .withFailureHandler(error => {
                                showMessage(messageBoxModal, `Gagal menambah data: ${error.message}`, 'alert-danger');
                            })
                            .addTransaksi(transaksi);
                    }
                } else {
                    showMessage(messageBoxModal, 'Koneksi ke server gagal. Pastikan skrip telah di-deploy.', 'alert-danger');
                }
            });

            confirmDeleteBtn.addEventListener('click', () => {
                if (deleteId !== null) {
                    if (typeof google !== 'undefined' && typeof google.script.run !== 'undefined') {
                        google.script.run
                            .withSuccessHandler(() => {
                                modalDelete.hide();
                                loadData();
                            })
                            .withFailureHandler(error => {
                                console.error("Error deleting data:", error);
                            })
                            .deleteTransaksi(deleteId);
                    }
                }
            });

            cetakPdfBtn.addEventListener('click', () => {
                const printContent = `
                    <style>
                        body { font-family: sans-serif; padding: 20px; }
                        h1 { color: #0d6efd; }
                        h2 { margin-top: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #0d6efd; color: white; }
                        .text-end { text-align: right; }
                        .text-success { color: #198754; }
                        .text-danger { color: #dc3545; }
                        .badge { display: inline-block; padding: .35em .65em; font-size: .75em; font-weight: 700; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: .25rem; }
                        .bg-success { background-color: #198754!important; color: white; }
                        .bg-danger { background-color: #dc3545!important; color: white; }
                    </style>
                    <h1>Laporan Kas RT</h1>
                    <h2>Ringkasan Bulanan Tahun ${document.getElementById('tahunRingkasan').textContent}</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Bulan</th>
                                <th class="text-end">Total Pemasukan</th>
                                <th class="text-end">Total Pengeluaran</th>
                                <th class="text-end">Saldo Akhir</th>
                            </tr>
                        </thead>
                        <tbody>${ringkasanBulananTbody.innerHTML}</tbody>
                    </table>
                    <h2>Daftar Semua Transaksi Tahun ${document.getElementById('tahunTransaksi').textContent}</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Keterangan</th>
                                <th>Jenis</th>
                                <th class="text-end">Jumlah</th>
                            </tr>
                        </thead>
                        <tbody>${transaksiTbody.innerHTML}</tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="fw-bold text-end">Total Pemasukan:</td>
                                <td class="fw-bold text-end text-success">${totalPemasukan.textContent}</td>
                            </tr>
                            <tr>
                                <td colspan="3" class="fw-bold text-end">Total Pengeluaran:</td>
                                <td class="fw-bold text-end text-danger">${totalPengeluaran.textContent}</td>
                            </tr>
                            <tr>
                                <td colspan="3" class="fw-bold text-end">Saldo Akhir:</td>
                                <td class="fw-bold text-end">${saldoAkhir.textContent}</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
                if (typeof google !== 'undefined' && typeof google.script.run !== 'undefined') {
                    google.script.run
                        .withSuccessHandler(url => {
                            window.open(url, '_blank');
                        })
                        .createPDF(printContent);
                }
            });

            filterBulan.addEventListener('change', loadData);
            filterTahun.addEventListener('change', loadData);
            
            modalJumlah.addEventListener('input', (e) => {
                const val = e.target.value.replace(/\D/g, '');
                e.target.value = val ? formatNumber(val) : '';
            });

            loadData();
        });
    </script>
</body>
</html>

